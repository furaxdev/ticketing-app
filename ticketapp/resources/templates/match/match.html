{% extends 'base.html' %} {% load json %} {% block content %}

<link rel="stylesheet" href="/static/css/match.css" />
<script src="https://unpkg.com/vue@3"></script>
{% for match in matches %}
<div class="card mb-5" style="width: 100%">
  <div class="card-title">
    <div class="d-flex justify-content-around px-3 py-2">
      <p>{{match.name}}</p>
      <div class="d-flex justify-content-center">
        <p class="mx-2">{{match.series.name|upper}}</p>
        <img src="/{{match.series.image}}" alt="" width="30" height="30" />
      </div>
      
      <img class="mx-2" src="/{{match.series.game.image}}" alt="" width="30" height="30" />
    </div>
    <div class="card-body">
      <div class="row align-items-center ">
        <div class="col-4 d-flex align-items-center justify-content-around flex-column">
          <img
          src="/{{match.team1_image}}"
          class="mb-2"
          alt=""
          width="80"
          height="80"
          />
          <h4>{{match.team1_name|upper}}</h4>
        </div>
        <div class="col-4 d-flex align-items-center flex-column justify-content-around">
          <h3>vs</h3>
          <p>{{match.start_time}}</p>
        </div>
        <div class="col-4 d-flex align-items-center justify-content-around flex-column">
          <img
          src="/{{match.team2_image}}"
          class="mb-2"
          alt=""
          width="80"
          height="80"
          />
          <h4>{{match.team2_name|upper}}</h4>
        </div>
      </div>
      <div class="d-flex justify-content-center">
        <a class="btn btn-success" href="/matches/{{match.id}}">Get Tickets</a>
      </div>
    </div>
  </div>
  
  
  {% comment %}
  <div class="col-megamenu">
    <h6 class="title">{{match.name}}</h6>
    
    <ul class="list-unstyled">
      {% for series in match.series.all() %}
      <li><a href="#">{{series.name}}</a></li>
      {% endfor %}
    </ul>
  </div>
  {% endcomment %}
  <!-- col-megamenu.// -->
</div>
<!-- end col-3 -->
{% endfor %} 
<div id="app">
  <div class="stadium">
    <div class="left">
      <div class="card west-box">
        <div class="card-header">West</div>
        <div class="card-body block-west">
          <div
            v-for="(row,j) in blocks['west']"
            :key="j"
            class="d-flex justify-content-between row-west"
          >
            <div v-for="seat in row.seats">
              <div
                v-if="!checkselected(seat.id)"
                @click="e=>select(seat.id)"
                :class="'seat-'+seat.type+' seat'"
              ></div>
              <div
                v-else
                @click="e=>deselect(seat.id)"
                :class="'seat-'+seat.type+' seat-selected'"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="middle">
      <div class="card">
        <div class="card-header">North</div>
        <div class="card-body block-north">
          <div
            v-for="(row,j) in blocks['north']"
            :key="j"
            class="d-flex justify-content-between row-north"
          >
          <div v-for="seat in row.seats">
            <div
              v-if="!checkselected(seat.id)"
              @click="e=>select(seat.id)"
              :class="'seat-'+seat.type+' seat'"
            ></div>
            <div
              v-else
              @click="e=>deselect(seat.id)"
              :class="'seat-'+seat.type+' seat-selected'"
            ></div>
          </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">South</div>
        <div class="card-body block-south">
          <div
            v-for="(row,j) in blocks['south']"
            :key="j"
            class="d-flex justify-content-between row-south"
          >
          <div v-for="seat in row.seats">
            <div
              v-if="!checkselected(seat.id)"
              @click="e=>select(seat.id)"
              :class="'seat-'+seat.type+' seat'"
            ></div>
            <div
              v-else
              @click="e=>deselect(seat.id)"
              :class="'seat-'+seat.type+' seat-selected'"
            ></div>
          </div>
          </div>
        </div>
      </div>
    </div>
    <div class="right">
      <div class="card east-box">
        <div class="card-header">East</div>
        <div class="card-body block-east">
          <div
            v-for="(row,j) in blocks['east']"
            :key="j"
            class="d-flex justify-content-between row-east"
          >
          <div v-for="seat in row.seats">
            <div
              v-if="!checkselected(seat.id)"
              @click="e=>select(seat.id)"
              :class="'seat-'+seat.type+' seat'"
            ></div>
            <div
              v-else
              @click="e=>deselect(seat.id)"
              :class="'seat-'+seat.type+' seat-selected'"
            ></div>
          </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<div class="container my-5">
  <h5>Selected Seats</h5>
  <table class="table">
    <thead>
      <tr>
        <th>Seat Name</th>
        <th>Type</th>
        <th>Price</th>
      </tr>
    </thead>
    <tbody>
    <tr v-for="seat in selectedseatsdata.seats">
      <td scope="row">
        [[seat.name]]
      </td>
        <td>[[seat.type]]</td>
        <td>
          [[seat.price]]
        </td></tr>

      <tr>
        
      </tr>
 
        <tr>
          <th></th>
          <th>Total</th>
          <th>[[selectedseatsdata.total]]</th>


        </tr>
        <tr v-if="selectedSeats.length > 0">
          <th></th>
          <th></th>
          <th>    <form>
            {% csrf_token %}
              <input type="text" name="seats" :value="selectedseatsdata.seatsstring" hidden />
              <input type="number" name="match" :value="match.id" hidden  />
            <button type="submit" class="btn btn-success">Checkout</button>
      
          </form></th>

          
        </tr>
    
    </tbody>

 

  </table>


</div>

  <script>
    console.log(
      JSON.parse("{{ matches|json }}".replaceAll("&quot;", '"'))[0].fields
    );
    Vue.createApp({
      delimiters: ["[[", "]]"],
      computed: {
        blocks() {
          const rows = this.rows;
          let blocks = {};

          const seats = this.seats;
          console.log(seats);
          rowswithseats = rows.map((r) => {
            console.log(r);
            _seats = seats
              .filter((s) => s.row == r.id)
              .sort((a, b) => a.index - b.index);

            console.log(_seats);
            return {
              ...r,
              seats: _seats,
            };
          });

          let blocknames = ["east", "west", "north", "south"];

          blocknames
            .map((name) => {
              blocks[name] = rowswithseats.filter((r) => r.block == name);
            })
            .sort((a, b) => a.index - b.index);

          console.log(seats);
          return blocks;
        },
        selectedseatsdata(){
          const _seats= this.selectedSeats
          const seats = _seats.map(s => {
            return {
              ...s,
              price : s.type==='VIP' ? this.match.vipTicketPrice : s.type=="premium" ? this.match.platinumTicketPrice : this.match.normalTicketPrice
            }
          })

          const total = seats.reduce((total , seat) => seat.price+total , 0)
          const seatsstring = seats.map(s=>s.id).toString()
          return {
            seats,total , seatsstring
          }
        }
     
      },
      data() {
        return {
          selectedSeats: [],
          match: JSON.parse("{{ matches|json }}".replaceAll("&quot;", '"')).map(e=>({ ...e.fields, id: e.pk }))
          [0],
          seats: JSON.parse("{{ seats|json }}".replaceAll("&quot;", '"')).map(
            (e) => ({ ...e.fields, id: e.pk })
          ),
          rows: JSON.parse("{{ rows|json }}".replaceAll("&quot;", '"')).map(
            (e) => ({ ...e.fields, id: e.pk })
          ),
        };
      },
      methods: {
        select(id) {
          const seat = this.seats.find((seat) => seat.id == id);
          this.selectedSeats = [...this.selectedSeats, seat];
          console.log(this.selectedSeats);
        },

        checkselected(id) {
          return this.selectedSeats.find(s=>s.id ==id)
        },

        deselect(id) {
          this.selectedSeats = this.selectedSeats.filter(e=> e.id!= id)
          console.log(this.selectedSeats);
        },
      },
    }).mount("#app");
  </script>

  {% endblock content %}
</div>
